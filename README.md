## B站历史弹幕下载脚本

此脚本用于下载b站视频的历史弹幕，合并弹幕文件.

目前多数浏览器插件的弹幕下载功能仅支持下载固定数量（取决于视频可装载的弹幕容量）的最新的弹幕.此外，少数支持历史弹幕下载的插件或多或少都存在 API老旧或代码效率底下等问题.

众所周知此类脚本的耗时瓶颈在于API请求时间间隔，BiliDanmuToolkit在保证尽可能全面地获取全弹幕的同时，通过优化内部逻辑使得发出的API请求尽可能少，查找并删除重复弹幕的效率尽可能高，从而缩短获取全弹幕所需的时间.

目前脚本还处于开发阶段，目前测试过以下五个视频弹幕均可完美抓取，括号中是每个视频的特征:

* av810872 (121万弹幕，弹幕池3000，含有大量高级弹幕和固定弹幕，存在无弹幕的日期)，耗时33分钟.
* av43526 (19万弹幕，弹幕池500，2010年视频，含有代码弹幕)，耗时35分钟.
* av83828800 (近期发布的视频，少量弹幕, 作为一般视频的测试样例)，耗时20秒.
* ep281207 (电影)
* ss21542 (番剧)

## Requirements

运行所需环境如下

* Python==3.7
* requests (通过`pip install` 或者 `conda install` 来安装)

## 实现的功能

* 获取一个视频的当前弹幕池、所有历史弹幕，并单独存储每次发出请求所返回的所有弹幕.
* 支持合并弹幕文件，并排除相同弹幕（并非文字相同，而是唯一标识符相同，即exact one.弹幕文字相同，唯一标识符不同的弹幕会保留）.
* 获取视频标题、av号、发布时间.
* 每次API请求时间间隔5秒（建议大家善用API，尽量不要频繁发起请求，减少服务器压力.上一次禁用历史弹幕API的时候B站官方的解释是服务器压力过大.）
* 支持分P视频.
* 支持番剧和电影的链接,包括"ep1234"及"ss1234"结尾的链接.
* 由于每次请求的历史弹幕大概率会涵盖多天的内容, 因此通过读取每次获取弹幕的最早发送时间来确定下一次请求的历史弹幕的日期, 而不是请求每一天的历史弹幕, 从而减少请求次数.
* 支持命令行带参数运行

### TODO

* 出现断网或请求失败等异常时保存进度.
* 出现API被禁时等待一定时间后重新发起请求.
* 批量添加av号.
* 历史弹幕的结束判定:优先使用历史弹幕日期列表来判断,当返回值不为`200`时,再使用备选判断方案.
* 弹幕合并检查时尝试使用UNIX时间戳判定, 并与用rowID判定所生成的结果相比较, 
如果结果相同则以后将采用UNIX时间戳来对弹幕的合并进行判定,这样会快很多.

### 存在的问题
正常情况下判断历史弹幕结束获取的方式是看获取到的最早的弹幕是否和视频发布日期匹配,
但是由于以下两种情况,导致无法通过上述方式结束获取:
* 视频的弹幕极少,可能隔很久才有一个弹幕, 造成获取过于缓慢(需要尝试每一天的历史弹幕)
* 番剧和电影无法获取视频的真实发布时间.

理论上可以通过获取历史弹幕日期列表(就是查看哪一天发过弹幕的API)来确定抓取的日期来弥补上面的缺陷,
但是目前b站似乎对这个API的使用次数有很严格的限制,因此此方法虽然已经实现(FullDanmuGen.py: `Danmu._get_history_month()`)但并没有采用.

因此目前使用以下两个判定条件来尽量提高全弹幕获取效率:
* 连续5天0弹幕(最后一道防线,但会让极少数视频提前结束获取)
* 返回的弹幕数量少于弹幕池限制, 说明已经不存在更早的弹幕.

## 使用方法
1. 配置python环境.
2. 使用电脑打开视频页面，复制地址栏中的链接，注意删除后面的无用项，最终复制得到以下四种样式的url
   1. `https://www.bilibili.com/video/av810872?p=1`
   2. `https://www.bilibili.com/video/av810872`
   3. `https://www.bilibili.com/bangumi/play/ep281207`
   4. `https://www.bilibili.com/bangumi/play/ss21542`
3. 将url粘贴在代码中的这一段

```
if __name__=='__main__':
    target = ''
    if len(sys.argv)<2:
        target = 'https://www.bilibili.com/video/av314'  # 将你的网址粘贴在这里
    else:
        target = sys.argv[1]
    print('开始分析', target)
    dm = Danmu()
    dm.from_url(target)
```

4. 将`cookie_sample.cfg`文件改名为`cookie.cfg`，删除里面的内容并粘贴自己的B站cookie到文件中(请求历史弹幕的必要条件).注意文本编码必须为`utf-8`.
5. 运行程序
6. 获取的弹幕文件在`harvest`文件夹中.

命令行玩家无视上面的第三个步骤, 启动方式如下:
```bash
$ cd BilibiliHistoryDanmuDownloader/
$ python FullDanmuGen.py 'https://www.bilibili.com/video/av314'
```

注1: B站cookie直接从浏览器中查找cookie内容,并粘贴到`cookie.cfg`即可, 不要带"Cookie:".
注2: 获取到的弹幕样例在harvest文件夹.

## 注意事项
B站对API接口的限制以及弹幕数据库的限制会影响获取的效果, 有时会因官方服务器波动而获取不全面, 需要等待几天后再尝试.

B站cookie直接从浏览器中查找cookie内容,并粘贴到`cookie.cfg`即可, 不要带"Cookie:".

获取到的弹幕样例在harvest文件夹.

由于b站每次请求历史弹幕都只返回“1个弹幕池容量”数量的弹幕，因此如果历史某一天的弹幕数量大于这个弹幕池的数量，则当天早些时候发的弹幕就无法获取到，因此最后获取的总弹幕数量会小于网站标称的数量.

* av810872 标称121万，实际获取90万.
* av43526 标称19万，实际获取16万.

