## B站历史弹幕下载脚本

此脚本用于下载b站视频的历史弹幕，合并弹幕文件.

目前多数浏览器插件的弹幕下载功能仅支持下载固定数量（取决于视频可装载的弹幕容量）的最新的弹幕.此外，少数支持历史弹幕下载的插件或多或少都存在 API老旧或代码效率底下等问题.

众所周知此类脚本的耗时瓶颈在于API请求时间间隔，BilibiliHistoryDanmuDownloader在保证尽可能全面地获取全弹幕的同时，通过优化内部逻辑使得发出的API请求尽可能少，查找并删除重复弹幕的效率尽可能高，从而缩短获取全弹幕所需的时间.

目前脚本还处于开发阶段，目前测试过以下三个视频弹幕均可完美抓取，括号中是每个视频的特征:

* av810872 (121万弹幕，弹幕池3000，含有大量高级弹幕和固定弹幕，存在无弹幕的日期)，耗时33分钟.
* av43526 (19万弹幕，弹幕池500，2010年视频，含有代码弹幕)，耗时35分钟.
* av83828800 (近期发布的视频，少量弹幕, 作为一般视频的测试样例)，耗时20秒.

## Requirements

运行所需环境如下

* Python==3.7
* requests (通过`pip install` 或者 `conda install` 来安装)

## 实现的功能

* 获取一个视频的当前弹幕池、所有历史弹幕，并单独存储每次发出请求所返回的所有弹幕.
* 支持合并弹幕文件，并排除相同弹幕（并非文字相同，而是唯一标识符相同，即exact one.弹幕文字相同，唯一标识符不同的弹幕会保留）.
* 获取视频标题、av号、发布时间.
* 每次API请求时间间隔5秒（建议大家善用API，尽量不要频繁发起请求，减少服务器压力.上一次禁用历史弹幕API的时候B站官方的解释是服务器压力过大.）
* 支持分P视频.
* 由于每次请求的历史弹幕大概率会涵盖多天的内容, 因此通过读取每次获取弹幕的最早发送时间来确定下一次请求的历史弹幕的日期, 而不是请求每一天的历史弹幕, 从而减少请求次数.
* 支持命令行带参数运行

### TODO

* 出现断网或请求失败等异常时保存进度.
* 出现API被禁时等待一定时间后重新发起请求.
* 批量添加av号.

## 使用方法
1. 配置python环境.
2. 使用电脑打开视频页面，复制地址栏中的链接，注意删除后面的无用项，最终复制得到以下两种样式的url
   1. `https://www.bilibili.com/video/av810872?p=1`
   2. `https://www.bilibili.com/video/av810872`
3. 将url粘贴在代码中的这一段 (在310行左右)

```
if __name__=='__main__':
    target = ''
    if len(sys.argv)<2:
        target = 'https://www.bilibili.com/video/av314'  # 将你的网址粘贴在这里
    else:
        target = sys.argv[1]
    print('开始分析', target)
    dm = Danmu()
    dm.from_url(target)
```

4. 将`cookie_sample.cfg`文件改名为`cookie.cfg`，删除里面的内容并粘贴自己的B站cookie到文件中(请求历史弹幕的必要条件).注意文本编码必须为`utf-8`.
5. 运行程序
6. 获取的弹幕文件在`harvest`文件夹中.

命令行玩家无视上面的第三个步骤, 启动方式如下:
```bash
$ cd BilibiliHistoryDanmuDownloader/
$ python FullDanmuGen.py 'https://www.bilibili.com/video/av314'
```

注1: B站cookie直接从浏览器中查找cookie内容,并粘贴到`cookie.cfg`即可, 不要带"Cookie:".
注2: 获取到的弹幕样例在harvest文件夹.

## 注意事项
B站对API接口的限制以及弹幕数据库的限制会影响获取的效果, 有时会因官方服务器波动而获取不全面, 需要等待几天后再尝试.

B站cookie直接从浏览器中查找cookie内容,并粘贴到`cookie.cfg`即可, 不要带"Cookie:".

获取到的弹幕样例在harvest文件夹.

由于b站每次请求历史弹幕都只返回“1个弹幕池容量”数量的弹幕，因此如果历史某一天的弹幕数量大于这个弹幕池的数量，则当天早些时候发的弹幕就无法获取到，因此最后获取的总弹幕数量会小于网站标称的数量.

* av810872 标称121万，实际获取90万.
* av43526 标称19万，实际获取16万.

